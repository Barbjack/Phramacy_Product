<Page x:Class="Phramacy_Product.Views.Sales.NewSalePage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:Phramacy_Product.Views.Sales"
      xmlns:sys="clr-namespace:System;assembly=mscorlib"
      xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
      Title="NewSalePage">
    <Page.Resources>
        <Style x:Key="ValidationErrorTextBox" TargetType="TextBox" BasedOn="{StaticResource MaterialDesignOutlinedTextBox}">
            <Style.Triggers>
                <Trigger Property="Validation.HasError" Value="True">
                    <Setter Property="BorderBrush" Value="Red"/>
                    <Setter Property="ToolTip"
                    Value="{Binding RelativeSource={RelativeSource Self}, Path=(Validation.Errors)[0].ErrorContent}"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="ValidationErrorComboBox" TargetType="ComboBox" BasedOn="{StaticResource MaterialDesignOutlinedComboBox}">
            <Style.Triggers>
                <Trigger Property="Validation.HasError" Value="True">
                    <Setter Property="BorderBrush" Value="Red"/>
                    <Setter Property="ToolTip"
                    Value="{Binding RelativeSource={RelativeSource Self}, Path=(Validation.Errors)[0].ErrorContent}"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="WhiteHeaderStyle" TargetType="DataGridColumnHeader">
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Background" Value="#2563EB"/>
            <Setter Property="Height" Value="38"/>
            <!-- Optional: Blue background -->
            <Setter Property="HorizontalContentAlignment" Value="Center"/>
        </Style>
    </Page.Resources>

    <ScrollViewer>
        <StackPanel Margin="20">
            <!-- Dropdowns Row (Owner, Payment, GST) with Gear Icon -->

            <materialDesign:DialogHost  x:Name="RootDialogHost" Margin="0,0,0,20" Padding="10"
                     Background="White"
                     HorizontalAlignment="Right">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="2*"/>
                        <ColumnDefinition Width="2*"/>
                        <ColumnDefinition Width="2*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <!-- Owner Dropdown -->
                    <ComboBox Grid.Column="0" Margin="5" x:Name="formCreatedBy"
                  materialDesign:HintAssist.Hint="Select Member"
                  Style="{StaticResource MaterialDesignOutlinedComboBox}">
                        <ComboBoxItem Content="Owner" IsSelected="True"/>
                        <ComboBoxItem Content="Manager"/>
                        <ComboBoxItem Content="Staff"/>
                    </ComboBox>

                    <!-- Select Payment Dropdown -->
                    <ComboBox Grid.Column="1" Margin="5" x:Name="formPaymentType"
                         materialDesign:HintAssist.Hint="Select Payment"
                         Style="{StaticResource MaterialDesignOutlinedComboBox}"
                         IsEnabled="False"
                         SelectionChanged="FormPaymentType_SelectionChanged">
                        <ComboBoxItem Content="Cash" />
                        <ComboBoxItem Content="Online"/>
                    </ComboBox>

                    <!-- With GST Dropdown -->
                    <ComboBox Grid.Column="2" Margin="5" x:Name="formGSTOption"
                  materialDesign:HintAssist.Hint="With GST"
                  Style="{StaticResource MaterialDesignOutlinedComboBox}">
                        <ComboBoxItem Content="With GST" IsSelected="True"/>
                        <ComboBoxItem Content="Without GST"/>
                    </ComboBox>

                    <!-- Settings/Gear Icon -->
                    <Button Grid.Column="3" Margin="5"
                Style="{StaticResource MaterialDesignToolForegroundButton}"
                ToolTip="Settings">
                        <materialDesign:PackIcon Kind="Cog" Width="24" Height="24"/>
                    </Button>
                </Grid>

                <!-- Payment Dialog Content -->
                <materialDesign:DialogHost.DialogContent>
                    <StackPanel Margin="20" Width="300">
                        <TextBlock x:Name="dialogTitle" FontWeight="Bold" FontSize="18" Margin="0,0,0,10" />

                        <!-- Always show Payment Mode -->
                        <StackPanel Margin="0,10">
                            <TextBlock Text="Payment Mode" FontWeight="SemiBold" Margin="0,0,0,5"/>
                            <TextBox x:Name="dialogPaymentMode" IsReadOnly="True" Style="{StaticResource MaterialDesignOutlinedTextBox}" />
                        </StackPanel>

                        <!-- Online Payment Fields -->
                        <StackPanel x:Name="OnlinePaymentFields" Visibility="Collapsed" Margin="0,10">
                            <TextBlock Text="Payment App" FontWeight="SemiBold" Margin="0,0,0,5"/>
                            <TextBox x:Name="dialogPaymentApp" Style="{StaticResource MaterialDesignOutlinedTextBox}" />

                            <TextBlock Text="Transaction Number (UTR No)" FontWeight="SemiBold" Margin="10,10,0,5"/>
                            <TextBox x:Name="dialogTransactionNumber" Style="{StaticResource MaterialDesignOutlinedTextBox}" />
                        </StackPanel>

                        <!-- Paid Amount -->
                        <StackPanel Margin="0,10">
                            <TextBlock Text="Paid Amount" FontWeight="SemiBold" Margin="0,0,0,5"/>

                            <Border BorderBrush="#C4C4C4" BorderThickness="1" CornerRadius="3">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <TextBlock Grid.Column="0" Text="₹" VerticalAlignment="Center" Margin="5,0,0,0" Foreground="#333333"/>

                                    <TextBox x:Name="dialogPaidAmount" Grid.Column="1" BorderThickness="0" Background="Transparent">
                                        <TextBox.Text>
                                            <Binding Path="." UpdateSourceTrigger="PropertyChanged" ValidatesOnDataErrors="True">
                                                <Binding.ValidationRules>
                                                    <local:RequiredFieldValidationRule/>
                                                    <local:PositiveNumberValidationRule/>
                                                </Binding.ValidationRules>
                                            </Binding>
                                        </TextBox.Text>
                                    </TextBox>
                                </Grid>
                            </Border>
                        </StackPanel>

                        <!-- Buttons -->
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,20,0,0">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <Button Content="Cancel" Grid.Column="0" Margin="0,0,140,0" Click="DialogCancel_Click" />
                                <Button Content="Submit" Grid.Column="1" Click="DialogSubmit_Click" />
                            </Grid>
                        </StackPanel>
                    </StackPanel>
                </materialDesign:DialogHost.DialogContent>
            </materialDesign:DialogHost>
            <!-- Top Form -->
            <materialDesign:Card Margin="0,0,0,20" Padding="20" Background="White" >
                <StackPanel>
                    <!-- Top Grid (Customer Info, Doctor, Date) -->
                    <Grid Margin="0,0,0,20">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="2*"/>
                            <ColumnDefinition Width="2*"/>
                            <ColumnDefinition Width="2*"/>
                            <ColumnDefinition Width="2*"/>
                            <ColumnDefinition Width="2*"/>
                            <ColumnDefinition Width="2*"/>
                        </Grid.ColumnDefinitions>

                        <!-- Patient/Customer Number -->
                        <StackPanel Grid.Column="0" Margin="5">
                            <TextBlock>
            <Run Text=" *" Foreground="Red"/>
                            </TextBlock>
                            <TextBox x:Name="SearchNumberBox"
                 Style="{StaticResource ValidationErrorTextBox}"
                 materialDesign:HintAssist.Hint="Patient/Customer Number"
                 TextChanged="SearchTextBox_NumberChanged">
                                <TextBox.Text>
                                    <Binding ElementName="SearchNumberBox"
                     Path="."
                     UpdateSourceTrigger="PropertyChanged"
                     ValidatesOnDataErrors="True">
                                        <Binding.ValidationRules>
                                            <local:RequiredFieldValidationRule/>
                                        </Binding.ValidationRules>
                                    </Binding>
                                </TextBox.Text>
                            </TextBox>
                        </StackPanel>

                        <Popup x:Name="NumberPopup" PlacementTarget="{Binding ElementName=SearchNumberBox}" Placement="Bottom" StaysOpen="False" 
                           AllowsTransparency="True" PopupAnimation="Slide" IsOpen="False">
                            <Border Background="White" BorderBrush="Gray" BorderThickness="1" MaxHeight="200" Width="{Binding ElementName=SearchNumberBox, 
                                Path=ActualWidth}">
                                <ScrollViewer VerticalScrollBarVisibility="Auto">
                                    <ListBox x:Name="NumberList" SelectionChanged="NumberList_SelectionChanged" Background="White" BorderThickness="0">
                                        <ListBox.ItemTemplate>
                                            <DataTemplate>
                                                <StackPanel Margin="5">
                                                    <TextBlock Text="{Binding CustomerNumber}" FontWeight="SemiBold" FontSize="14"/>
                                                    <TextBlock>
                                                      <Run Text="{Binding CustomerName}"/>
                                                    </TextBlock>
                                                </StackPanel>
                                            </DataTemplate>
                                        </ListBox.ItemTemplate>
                                    </ListBox>
                                </ScrollViewer>
                            </Border>
                        </Popup>

                        <StackPanel Grid.Column="1" Margin="5">
                            <TextBlock>
            
            <Run Text=" *" Foreground="Red"/>
                            </TextBlock>
                            <TextBox x:Name="formCustomerName"
                 Style="{StaticResource ValidationErrorTextBox}"
                 materialDesign:HintAssist.Hint="Customer Name">
                                <TextBox.Text>
                                    <Binding ElementName="formCustomerName" Path="." UpdateSourceTrigger="PropertyChanged"
                                             ValidatesOnDataErrors="True">
                                        <Binding.ValidationRules>
                                            <local:RequiredFieldValidationRule/>
                                        </Binding.ValidationRules>
                                    </Binding>
                                </TextBox.Text>
                            </TextBox>
                        </StackPanel>

                        <StackPanel Grid.Column="2" Margin="5">
                            <TextBlock>
            
            <Run Text=" *" Foreground="Red"/>
                            </TextBlock>
                            <TextBox x:Name="formPatientName"
                 Style="{StaticResource ValidationErrorTextBox}"
                 materialDesign:HintAssist.Hint="Patient Name">
                                <TextBox.Text>
                                    <Binding ElementName="formPatientName"
Path="."
UpdateSourceTrigger="PropertyChanged"
ValidatesOnDataErrors="True">
                                        <Binding.ValidationRules>
                                            <local:RequiredFieldValidationRule/>
                                        </Binding.ValidationRules>
                                    </Binding>
                                </TextBox.Text>
                            </TextBox>
                        </StackPanel>

                        <!-- Doctor Name -->
                        <StackPanel Grid.Column="3" Margin="5">
                            <TextBlock>
           
            <Run Text=" *" Foreground="Red"/>
                            </TextBlock>
                            <TextBox x:Name="formDocName"
                 Style="{StaticResource ValidationErrorTextBox}"
                 materialDesign:HintAssist.Hint="Doctor/Prescriber Name">
                                <TextBox.Text>
                                    <Binding ElementName="formDocName"
Path="."
UpdateSourceTrigger="PropertyChanged"
ValidatesOnDataErrors="True">
                                        <Binding.ValidationRules>
                                            <local:RequiredFieldValidationRule/>
                                        </Binding.ValidationRules>
                                    </Binding>
                                </TextBox.Text>
                            </TextBox>
                        </StackPanel>

                        <!-- Bill Date -->
                        <StackPanel Grid.Column="4" Margin="5">
                            <TextBlock>
            
            <Run Text=" *" Foreground="Red"/>
                            </TextBlock>
                            <DatePicker x:Name="formBillDate"
                    Style="{StaticResource MaterialDesignOutlinedDatePicker}"
                    materialDesign:HintAssist.Hint="Bill Date"
                    SelectedDate="{Binding Path=CurrentDate, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
/>
                        </StackPanel>

                        <!-- Payment Date -->
                        <StackPanel Grid.Column="5" Margin="5">
                            <TextBlock>
            
            <Run Text=" *" Foreground="Red"/>
                            </TextBlock>
                            <DatePicker x:Name="formCreateAt"
                    Style="{StaticResource MaterialDesignOutlinedDatePicker}"
                    materialDesign:HintAssist.Hint="Payment Date"
                    SelectedDate="{Binding Path=CurrentDate, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
/>
                        </StackPanel>
                    </Grid>

                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="3*"/>
                            <ColumnDefinition Width="1.5*"/>
                            <ColumnDefinition Width="1.5*"/>
                            <ColumnDefinition Width="1.5*"/>
                        </Grid.ColumnDefinitions>
                        <Grid Grid.Column="0">
                            <!-- Search TextBox -->
                            <TextBox x:Name="SearchTextBox" Margin="5" 
                 Style="{StaticResource MaterialDesignOutlinedTextBox}" 
                 materialDesign:HintAssist.Hint="Search medicine (min 3 characters)"
                 TextChanged="SearchTextBox_TextChanged"/>

                            <!-- Suggestion Popup -->
                            <Popup x:Name="SuggestionPopup" PlacementTarget="{Binding ElementName=SearchTextBox}" Placement="Bottom" StaysOpen="False" 
                     AllowsTransparency="True" PopupAnimation="Slide" IsOpen="False">
                                <Border Background="White" BorderBrush="Gray" BorderThickness="1" MaxHeight="200" Width="{Binding ElementName=SearchTextBox, Path=ActualWidth}">
                                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                                        <ListBox x:Name="SuggestionList" SelectionChanged="SuggestionList_SelectionChanged" Background="White" BorderThickness="0">
                                            <ListBox.ItemTemplate>
                                                <DataTemplate>
                                                    <StackPanel Margin="5">
                                                        <TextBlock Text="{Binding ProductName}" FontWeight="Bold" FontSize="14"/>
                                                        <TextBlock>
                                        <Run Text="{Binding CompanyName}"/>
                                        <Run Text=" | "/>
                                        <Run Text="{Binding StripInfo}"/>
                                                        </TextBlock>
                                                        <TextBlock>
                                        <Run Text="MRP ₹"/>
                                        <Run Text="{Binding MRP}"/>
                                        <Run Text=" | Stock: "/>
                                        <Run Text="{Binding Stock}"/>
                                                        </TextBlock>
                                                    </StackPanel>
                                                </DataTemplate>
                                            </ListBox.ItemTemplate>
                                        </ListBox>
                                    </ScrollViewer>
                                </Border>
                            </Popup>
                        </Grid>
                        <ComboBox x:Name="qtyType" Grid.Column="1" Margin="5" 
                                  materialDesign:HintAssist.Hint="Select Sale Type"
                            Style="{StaticResource MaterialDesignOutlinedComboBox}">
                            <ComboBoxItem Content="QTY(F)"/>
                            <ComboBoxItem Content="QTY(L)"/>
                        </ComboBox>

                        <TextBox Grid.Column="2" Margin="5" x:Name="quantity"
                     Style="{StaticResource MaterialDesignOutlinedTextBox}"
                     materialDesign:HintAssist.Hint="Quantity"/>
                        <Button Grid.Column="3" Margin="5" Content="Add to Customer Bill" Click="AddBill_CustomerDetails" Foreground="White" Background="Gray">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="Padding" Value="10,4"/>
                                    <Setter Property="FontSize" Value="14"/>
                                    <Setter Property="FontWeight" Value="SemiBold"/>
                                    <Setter Property="Cursor" Value="Hand"/>
                                    <Setter Property="Background" Value="Gray"/>
                                    <Setter Property="Foreground" Value="White"/>
                                    <Setter Property="BorderBrush" Value="Gray"/>
                                    <Setter Property="BorderThickness" Value="1"/>
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="Button">
                                                <Border Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="4"
                                SnapsToDevicePixels="True">
                                                    <ContentPresenter HorizontalAlignment="Center"
                                              VerticalAlignment="Center"
                                              RecognizesAccessKey="True"/>
                                                </Border>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </Button.Style>
                        </Button>
                    </Grid>
                </StackPanel>
            </materialDesign:Card>

            <!-- Product Table -->
            <DataGrid x:Name="ProductGrid" AutoGenerateColumns="False" HeadersVisibility="Column" CanUserAddRows="False" Margin="0,0,0,10" 
          ColumnHeaderStyle="{StaticResource WhiteHeaderStyle}">
                <DataGrid.Columns>
                    <DataGridTextColumn Header="PRODUCT NAME" Binding="{Binding ProductName}" Width="*"/>
                    <DataGridTextColumn Header="BATCH NUMBER" Binding="{Binding BatchNumber}" Width="*"/>
                    <DataGridTextColumn Header="EXPIRY" Binding="{Binding Expiry}" Width="*"/>
                    <DataGridTextColumn Header="QTY(F)" Binding="{Binding QtyF}" Width="*"/>
                    <DataGridTextColumn Header="QTY(L)" Binding="{Binding QtyL}" Width="*"/>
                    <DataGridTextColumn Header="M.R.P" Binding="{Binding MRP,StringFormat='₹{0}'}" Width="*"/>
                    <DataGridTextColumn Header="DISC%" Binding="{Binding Discount}" Width="*"/>
                    <DataGridTextColumn Header="GST%" Binding="{Binding GST}" Width="*"/>
                    <!--DataGridTextColumn Header="PAID AMOUNT" Binding="{Binding PaidAmount}" Width="*"/-->
                    <DataGridTextColumn Header="TOTAL AMOUNT" Binding="{Binding Total, StringFormat='₹{0}'}" Width="*"/>
                    <DataGridTemplateColumn Header="DELETE ITEM" Width="*">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Button Content="❌" Click="DeleteRow_Click" Foreground="Red"/>
                                
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                </DataGrid.Columns>
            </DataGrid>

            <materialDesign:Card Margin="0,40,0,20" Background="White">
                <Grid Margin="10,20">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <TextBlock x:Name="Total_Amount" Text="Total Amount: " FontWeight="Bold" VerticalAlignment="Center" Grid.Column="0"/>
                    <Button Content="Save Sale" Click="AddTo_SaleItemDetailPharmaCustomer" Width="100" Background="#2563EB" Foreground="White" Margin="0,0,0,0" VerticalAlignment="Center" Grid.Column="1"/>
                </Grid>
            </materialDesign:Card>
        </StackPanel>
    </ScrollViewer>
</Page>
